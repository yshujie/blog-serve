version: '3.8'
services:
  backend:
    build:
      context: ../../..  # 后端需要整个项目根目录，因为可能依赖其他目录
      dockerfile: build/docker/miniblog/Dockerfile.prod.backend
      network: host
      args:
        - GOPROXY=https://goproxy.cn,direct
        - HTTP_PROXY=http://host.docker.internal:7890
        - HTTPS_PROXY=http://host.docker.internal:7890
        - GO111MODULE=on
    extra_hosts:
      - "host.docker.internal:host-gateway"
    network_mode: "host"
    environment:
      - DB_HOST=localhost
      - DB_PORT=3306
      - DB_USER=miniblog
      - DB_PASSWORD=miniblog123
      - DB_NAME=miniblog
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
    restart: always
    ports:
      - "8081:8081"


  frontend:
    build:
      context: ../../../web/miniblog-web  # 只包含前端项目目录
      dockerfile: ../../build/docker/miniblog/Dockerfile.prod.frontend  # 相对于前端项目目录的路径
      network: host
      args:
        - HTTP_PROXY=http://host.docker.internal:7890
        - HTTPS_PROXY=http://host.docker.internal:7890
    extra_hosts:
      - "host.docker.internal:host-gateway"
    network_mode: "host"
    restart: always
    ports:
      - "3000:3000"